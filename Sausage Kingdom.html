<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸è‚²æˆã‚²ãƒ¼ãƒ </title>
<style>
  :root{
    --bg:#fff7ef;
    --panel:#fff;
    --accent:#ff8a65;
    --muted:#666;
    --good:#2e7d32;
    --bad:#c62828;
  }
  body{
    background: linear-gradient(180deg,#fff7ef 0%, #ffdca8 100%);
    font-family: "Noto Sans JP", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    margin:0;
    padding:20px;
    color:#222;
  }
  .container{max-width:900px;margin:0 auto;}
  header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
  h1{margin:0;font-size:1.6rem}
  .game{
    display:grid;
    grid-template-columns: 320px 1fr;
    gap:16px;
  }
  .card{
    background:var(--panel);
    border-radius:12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    padding:14px;
  }
  .sausage{
    font-size:72px;
    text-align:center;
    padding:10px 6px;
  }
  .status-list{display:grid;gap:8px}
  .stat{
    display:flex;justify-content:space-between;align-items:center;
    gap:10px;padding:6px;border-radius:8px;background:#fff9f4;border:1px solid rgba(0,0,0,0.03);
  }
  .bar{
    height:12px;border-radius:8px;background:#eee;flex:1;margin-left:10px;margin-right:6px;overflow:hidden;
  }
  .bar > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#ffb74d);width:0%}
  .controls{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
  button{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;background:var(--accent);color:white;font-weight:600}
  button.secondary{background:#fff;border:1px solid #ddd;color:#333}
  .log{height:140px;overflow:auto;background:#fffbe8;padding:8px;border-radius:8px;border:1px dashed #ffd9b6}
  .meta{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
  .small{font-size:0.9rem;color:var(--muted)}
  .center{display:flex;justify-content:center;align-items:center}
  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:none;align-items:center;justify-content:center;z-index:60}
  .modal{background:white;padding:18px;border-radius:12px;min-width:320px;box-shadow:0 12px 30px rgba(0,0,0,0.25)}
  .choices{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  .choice{flex:1;padding:10px;border-radius:10px;border:1px solid #ddd;text-align:center;cursor:pointer}
  .stage-tag{display:inline-block;padding:4px 8px;border-radius:999px;background:#fff2e6;border:1px solid #ffd1a8;font-weight:700}
  .burnt{color:var(--bad);font-weight:800}
  footer{margin-top:18px;font-size:0.85rem;color:var(--muted)}
  @media(max-width:820px){
    .game{grid-template-columns:1fr; }
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸è‚²æˆã‚²ãƒ¼ãƒ  ğŸŒ­</h1>
    <div class="small">ã‹ã‚ã„ã„ / ã‹ã£ã“ã„ã„ã‚’é¸ã‚“ã§è‚²ã¦ã‚ˆã†ï¼çµŒé¨“å€¤ã§é€²åŒ–ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«é¸æŠï¼‰</div>
  </header>

  <div class="game">
    <div class="card">
      <div id="selection-area">
        <h3>æœ€åˆã®ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸ã‚’é¸ã‚“ã§ãã ã•ã„</h3>
        <div class="choices">
          <div class="choice" data-type="cute" id="choose-cute">
            <div style="font-size:48px">ğŸŒ¸ğŸ¥°</div>
            <div>ã‹ã‚ã„ã„ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸</div>
            <div class="small">ã‚¸ãƒ¥ãƒ¼ã‚·ãƒ¼ã§äººæ°—ãŒå‡ºã‚„ã™ã„</div>
          </div>
          <div class="choice" data-type="cool" id="choose-cool">
            <div style="font-size:48px">ğŸ”¥ğŸ˜</div>
            <div>ã‹ã£ã“ã„ã„ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸</div>
            <div class="small">ç„¼ããŒå¾—æ„ã§é•·ã•ãŒä¼¸ã³ã‚„ã™ã„</div>
          </div>
        </div>
      </div>

      <div id="game-area" style="display:none">
        <div class="sausage" id="sausage-visual">ğŸŒ­</div>
        <div class="meta">
          <div>ã‚¹ãƒ†ãƒ¼ã‚¸: <span id="stage" class="stage-tag">ãƒ™ãƒ“ãƒ¼</span></div>
          <div>é•·ã•: <strong id="lengthVal">10</strong> cm</div>
          <div>çµŒé¨“å€¤: <strong id="xpVal">0</strong></div>
        </div>

        <div class="status-list" id="status-list">
          <!-- stat rows injected by JS -->
        </div>

        <div class="controls">
          <button id="btn-bake">ç„¼ã ğŸ”¥</button>
          <button id="btn-ketchup" class="secondary">ã‚±ãƒãƒ£ãƒƒãƒ— ğŸ…</button>
          <button id="btn-mustard" class="secondary">ãƒã‚¹ã‚¿ãƒ¼ãƒ‰ ğŸŒ­</button>
          <button id="btn-exercise">é‹å‹•ï¼ˆã‚¹ãƒˆãƒ¬ãƒƒãƒï¼‰ğŸƒ</button>
          <button id="btn-rest" class="secondary">ä¼‘ã¾ã›ã‚‹ ğŸ’¤</button>
          <button id="btn-save" class="secondary">ã‚»ãƒ¼ãƒ–</button>
          <button id="btn-reset" class="secondary">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>

        <h4 style="margin-top:12px">ãƒ­ã‚°</h4>
        <div class="log" id="log"></div>
      </div>
    </div>

    <div class="card">
      <h3>èª¬æ˜ãƒ»ãƒ’ãƒ³ãƒˆ</h3>
      <ul>
        <li class="small">æ™‚é–“çµŒéã§ã‚¸ãƒ¥ãƒ¼ã‚·ãƒ¼åº¦ãƒ»äººæ°—åº¦ã¯å¾ã€…ã«ä¸‹ãŒã‚Šã¾ã™ã€‚ç„¼ãã™ãæ³¨æ„ï¼</li>
        <li class="small">ç„¼ãã¨ç„¼ãåŠ æ¸›ãŒä¸ŠãŒã‚Šã€ã‚¸ãƒ¥ãƒ¼ã‚·ãƒ¼åº¦ãŒæ¸›ã‚‹ã€‚ç„¦ã’ã‚‹ï¼ˆ100è¶…ï¼‰ã¨ãƒšãƒŠãƒ«ãƒ†ã‚£ã€‚</li>
        <li class="small">ã‚±ãƒãƒ£ãƒƒãƒ—/ãƒã‚¹ã‚¿ãƒ¼ãƒ‰ã¯äººæ°—åº¦ã‚’ä¸Šã’ã€å°‘é‡ã®çµŒé¨“å€¤ã‚‚ä¸ãˆã¾ã™ã€‚</li>
        <li class="small">é‹å‹•ã¯é•·ã•ã¨ã‚¸ãƒ¥ãƒ¼ã‚·ãƒ¼åº¦ã‚’å°‘ã—ä¸Šã’ã€çµŒé¨“å€¤ã‚‚å¢—ã‚„ã™ã€‚</li>
        <li class="small">ä¼‘ã¾ã›ã‚‹ã¨ã‚¸ãƒ¥ãƒ¼ã‚·ãƒ¼åº¦å›å¾©ã¨ç„¼ãåŠ æ¸›ã®è‡ªç„¶ä½ä¸‹ï¼ˆå†·ã¾ã™ï¼‰ãŒæ—©ããªã‚Šã¾ã™ã€‚</li>
        <li class="small">XPãŒé–¾å€¤ï¼ˆä¾‹: 30, 80, 200ï¼‰ã‚’è¶…ãˆã‚‹ã¨é€²åŒ–ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒå‡ºã¾ã™ã€‚</li>
      </ul>
      <hr>
      <h4>ä¿å­˜</h4>
      <div class="small">ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã‚»ãƒ¼ãƒ–ãƒœã‚¿ãƒ³ã§æ‰‹å‹•ä¿å­˜ã€‚</div>
      <footer>GitHubã«ç½®ãå ´åˆã¯ index.html ã‚’ãƒªãƒã‚¸ãƒˆãƒªã«è¿½åŠ ã—ã¦ GitHub Pages ã‚’æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„ã€‚</footer>
    </div>
  </div>
</div>

<!-- é€²åŒ–/é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-back" id="modal-back">
  <div class="modal" id="modal">
    <h3 id="modal-title">é€²åŒ–ã‚’é¸ã‚“ã§ãã ã•ã„</h3>
    <div id="modal-desc" class="small">çµŒé¨“å€¤ã«ã‚ˆã£ã¦é¸ã¹ã‚‹é€²åŒ–ãŒå¢—ãˆã¾ã™ã€‚</div>
    <div class="choices" id="modal-choices"></div>
    <div style="text-align:right;margin-top:10px">
      <button id="modal-cancel" class="secondary">ã‚ã¨ã§</button>
    </div>
  </div>
</div>

<script>
/*
  ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸è‚²æˆã‚²ãƒ¼ãƒ  - å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«å®Ÿè£…
  â€» ä¸­èº«ã¯ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã‚„ã™ãã—ã¦ã„ã¾ã™
*/

const DEFAULT = {
  doneness: 10, // ç„¼ãåŠ æ¸› 0-120 (100è¶…ã§ç„¦ã’)
  juiciness: 80, // ã‚¸ãƒ¥ãƒ¼ã‚·ãƒ¼åº¦ 0-100
  popularity: 40, // äººæ°—åº¦ 0-100
  length: 10, // é•·ã• (cm) ä»»æ„ã‚¹ã‚±ãƒ¼ãƒ«
  xp: 0,
  stage: 'ãƒ™ãƒ“ãƒ¼', // é€²åŒ–ã‚¹ãƒ†ãƒ¼ã‚¸å
  type: 'cute', // cute / cool
  name: '', // å¾Œã§ã¤ã‘ã‚‰ã‚Œã‚‹
  lastTick: Date.now()
};

let state = loadState() || {...DEFAULT};
let tickInterval = null;
const TICK_MS = 1000; // 1ç§’ã”ã¨ã«æ™‚é–“çµŒéå‡¦ç†

// XP thresholds for evolution (å¯å¤‰)
const EVOL_THRESHOLDS = [30, 80, 200];

// DOM refs
const selectionArea = document.getElementById('selection-area');
const gameArea = document.getElementById('game-area');
const sausageVisual = document.getElementById('sausage-visual');
const stageTag = document.getElementById('stage');
const lengthVal = document.getElementById('lengthVal');
const xpVal = document.getElementById('xpVal');
const statusList = document.getElementById('status-list');
const logEl = document.getElementById('log');
const modalBack = document.getElementById('modal-back');
const modalChoices = document.getElementById('modal-choices');
const modalTitle = document.getElementById('modal-title');
const modalDesc = document.getElementById('modal-desc');

document.getElementById('choose-cute').addEventListener('click', ()=>startGame('cute'));
document.getElementById('choose-cool').addEventListener('click', ()=>startGame('cool'));
document.getElementById('btn-bake').addEventListener('click', ()=>doAction('bake'));
document.getElementById('btn-ketchup').addEventListener('click', ()=>doAction('ketchup'));
document.getElementById('btn-mustard').addEventListener('click', ()=>doAction('mustard'));
document.getElementById('btn-exercise').addEventListener('click', ()=>doAction('exercise'));
document.getElementById('btn-rest').addEventListener('click', ()=>doAction('rest'));
document.getElementById('btn-save').addEventListener('click', saveStateAndLog);
document.getElementById('btn-reset').addEventListener('click', resetGame);
document.getElementById('modal-cancel').addEventListener('click', closeModal);

// åˆå›ãƒ­ãƒ¼ãƒ‰è¡¨ç¤º
render();

function startGame(type){
  state.type = type;
  state.stage = 'ãƒ™ãƒ“ãƒ¼';
  // åˆæœŸå€¤ã‚’ç¨®åˆ¥ã«ã‚ˆã‚Šå¾®èª¿æ•´
  if(type === 'cute'){
    state.juiciness = 90;
    state.popularity = 50;
    state.length = 9;
  } else {
    state.juiciness = 75;
    state.popularity = 35;
    state.length = 12;
  }
  state.xp = 0;
  state.doneness = 10;
  saveState();
  selectionArea.style.display = 'none';
  document.getElementById('game-area').style.display = '';
  log(`æ–°ã—ã„${type==='cute'?'ã‹ã‚ã„ã„':'ã‹ã£ã“ã„ã„'}ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸ã‚’è‚²ã¦å§‹ã‚ãŸï¼`);
  startTick();
  render();
}

function startTick(){
  if(tickInterval) clearInterval(tickInterval);
  tickInterval = setInterval(tick, TICK_MS);
}

function tick(){
  // æ™‚é–“å·®ã‚’è€ƒæ…®ã—ã¦å®‰å…¨ã«å‡¦ç†
  // æ¯ç§’: è‡ªå‹•æ¸›å°‘ã¨è‡ªå‹•XP
  // ç„¦ã’ï¼ˆdoneness>100) æ™‚ã¯ãƒšãƒŠãƒ«ãƒ†ã‚£ï¼šã‚¸ãƒ¥ãƒ¼ã‚·ãƒ¼æ¸›å°‘ãŒé€Ÿãã€äººæ°—åº¦ä¸‹ãŒã‚‹
  const burnt = state.doneness > 100;
  // è‡ªç„¶ã®å¤‰åŒ–ï¼ˆã‚¿ã‚¤ãƒ—ã«ã‚ˆã£ã¦å¾®èª¿æ•´ï¼‰
  const juicinessDecay = burnt ? 1.2 : 0.4;
  const popularityDecay = burnt ? 0.6 : 0.15;
  const donenessDecayWhileRest = 0.6; // å†·ã¾ã™ã¨ä¸‹ãŒã‚‹

  // è‡ªå‹•æ¸›å°‘
  state.juiciness = clamp(state.juiciness - juicinessDecay, 0, 200);
  state.popularity = clamp(state.popularity - popularityDecay, 0, 200);

  // è‡ªå‹• XPï¼ˆé£¼ã„ä¸»ãŒä¸–è©±ã—ã¦ã„ãªã„ã¨å°‘ã—ãšã¤å…¥ã‚‹ â€” æˆé•·ã®æ™‚é–“ï¼‰
  let xpGain = 0.05 + (state.popularity/5000) + (state.juiciness/10000);
  if(burnt) xpGain *= 0.5; // ç„¦ã’ã‚‹ã¨æˆé•·ãŒè½ã¡ã‚‹
  state.xp += xpGain;

  // å°‘ã—ã ã‘è‡ªç„¶ã«ç„¼ããŒé€²ã‚€ï¼ˆæ”¾ç½®ã§ç«ãŒé€šã‚‹ï¼‰
  state.doneness = clamp(state.doneness + 0.08, 0, 1000);

  // é•·ã•ã‚‚ã‚ãšã‹ã«æ¸›ã‚‹ï¼ˆä¹¾ç‡¥ï¼‰
  state.length = clamp(state.length - 0.002, 2, 300);

  // If juiciness too low, popularity drops more
  if(state.juiciness < 25) state.popularity = clamp(state.popularity - 0.3, 0, 200);

  // Check for XP threshold for evolution
  checkForEvolution();

  saveState();
  render();
}

// ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè£…
function doAction(action){
  if(!gameArea || gameArea.style.display === 'none') return;
  switch(action){
    case 'bake':
      state.doneness = clamp(state.doneness + 8 + (state.type==='cool'?3:0), 0, 1000);
      state.juiciness = clamp(state.juiciness - 6, 0, 200);
      state.xp += 2 + (state.type==='cool'?0.5:0);
      log('ç„¼ã„ãŸï¼ç„¼ãåŠ æ¸›ãŒä¸ŠãŒã£ãŸã€‚');
      // ç„¦ã’å§‹ã‚ãŸã‚‰è­¦å‘Š
      if(state.doneness > 95 && state.doneness <= 110) log('æ³¨æ„ï¼šç„¦ã’ãã†ï¼ğŸ”¥', true);
      if(state.doneness > 120){
        // ç„¦ã’éããƒšãƒŠãƒ«ãƒ†ã‚£
        state.popularity = clamp(state.popularity - 8, 0, 200);
        state.juiciness = clamp(state.juiciness - 8, 0, 200);
        log('ç„¦ã’ãŸï¼äººæ°—ã¨ã‚¸ãƒ¥ãƒ¼ã‚·ãƒ¼åº¦ãŒå¤§å¹…ãƒ€ã‚¦ãƒ³ï¼', true);
      }
      break;

    case 'ketchup':
      state.popularity = clamp(state.popularity + 6 + (state.type==='cute'?2:0), 0, 200);
      state.xp += 1;
      log('ã‚±ãƒãƒ£ãƒƒãƒ—ã‚’ã‹ã‘ãŸã€‚äººæ°—ãŒä¸ŠãŒã£ãŸï¼');
      break;

    case 'mustard':
      state.popularity = clamp(state.popularity + 4 + (state.type==='cool'?3:0), 0, 200);
      state.xp += 1;
      log('ãƒã‚¹ã‚¿ãƒ¼ãƒ‰ã‚’ã‹ã‘ãŸã€‚å€‹æ€§ãŒå‡ºãŸï¼');
      break;

    case 'exercise':
      // ã‚¹ãƒˆãƒ¬ãƒƒãƒã§é•·ã•ã¨ã‚¸ãƒ¥ãƒ¼ã‚·ãƒ¼ã•ã‚’å°‘ã—å›å¾©ã€XPã‚‚
      state.length = clamp(state.length + 0.4 + (state.type==='cool'?0.2:0), 2, 300);
      state.juiciness = clamp(state.juiciness + 3, 0, 200);
      state.xp += 3;
      state.popularity = clamp(state.popularity + 1, 0, 200);
      log('é‹å‹•ï¼ˆã‚¹ãƒˆãƒ¬ãƒƒãƒï¼‰ã—ãŸï¼é•·ã•ã¨ã‚¸ãƒ¥ãƒ¼ã‚·ãƒ¼åº¦ãŒä¸ŠãŒã£ãŸã€‚');
      break;

    case 'rest':
      // ä¼‘ã¾ã›ã‚‹ã¨ã‚¸ãƒ¥ãƒ¼ã‚·ãƒ¼å›å¾©ãƒ»ç„¼ãåŠ æ¸›ã®è‡ªç„¶ä½ä¸‹ï¼ˆå†·ã¾ã™ï¼‰
      state.juiciness = clamp(state.juiciness + 6, 0, 200);
      state.doneness = clamp(state.doneness - 6, 0, 1000);
      state.xp += 0.8;
      log('ä¼‘ã¾ã›ãŸã€‚å†·ã‚ã¦ã‚¸ãƒ¥ãƒ¼ã‚·ãƒ¼åº¦ãŒå›å¾©ã—ãŸã€‚');
      break;

    default:
      console.warn('unknown action', action);
  }
  saveState();
  render();
  checkForEvolution(); // å³æ™‚ãƒã‚§ãƒƒã‚¯ï¼ˆå¤§ããªXPå¢—åŠ ã®ã¨ãï¼‰
}

function checkForEvolution(){
  // Stage evolution logic: if XP past threshold and not already at or beyond that stage, show modal with options
  // We'll define simple stage ordering: ãƒ™ãƒ“ãƒ¼ -> è‹¥è‘‰ -> æˆç†Ÿ -> å®Œæˆ
  // For each threshold we offer choices
  const xp = state.xp;
  // Determine which threshold is next
  let nextIndex = EVOL_THRESHOLDS.findIndex(t => xp >= t && !state._evolvedAt?.includes(t));
  if(nextIndex >= 0){
    // Show choices for that threshold
    const threshold = EVOL_THRESHOLDS[nextIndex];
    showEvolutionModal(threshold);
  }
}

// é€²åŒ–ãƒ¢ãƒ¼ãƒ€ãƒ«
function showEvolutionModal(threshold){
  // ensure _evolvedAt array
  if(!state._evolvedAt) state._evolvedAt = [];
  // Prepare choices depending on threshold
  modalChoices.innerHTML = '';
  modalTitle.textContent = `é€²åŒ–ï¼ˆXP ${Math.round(state.xp)}ï¼‰ - é¸æŠã—ã¦ãã ã•ã„`;
  modalDesc.textContent = `ä»¥ä¸‹ã‹ã‚‰ä¸€ã¤é¸ã‚“ã§é€²åŒ–ã•ã›ã‚ˆã†ï¼ï¼ˆXP ${threshold}åˆ°é”ï¼‰`;
  const options = getEvolutionOptionsByThreshold(threshold);
  options.forEach(opt => {
    const d = document.createElement('div');
    d.className = 'choice';
    d.innerHTML = `<div style="font-size:28px">${opt.icon}</div><div style="font-weight:700">${opt.name}</div><div class="small">${opt.desc}</div>`;
    d.addEventListener('click', ()=>applyEvolution(opt, threshold));
    modalChoices.appendChild(d);
  });
  openModal();
}

function getEvolutionOptionsByThreshold(threshold){
  // example options mapping
  if(threshold === EVOL_THRESHOLDS[0]){ // 30
    return [
      {id:'cheese', name:'ãƒãƒ¼ã‚ºå…¥ã‚Šã‚½ãƒ¼ã‚»ãƒ¼ã‚¸', icon:'ğŸ§€ğŸŒ­', desc:'ã‚¸ãƒ¥ãƒ¼ã‚·ãƒ¼åº¦ãŒä¸ŠãŒã‚Šã€äººæ°—UP', apply: (s)=>{s.juiciness += 10; s.popularity += 8; s.stage='ãƒãƒ¼ã‚ºå…¥ã‚Š';}},
      {id:'hotdog', name:'ãƒ›ãƒƒãƒˆãƒ‰ãƒƒã‚°åŒ–', icon:'ğŸŒ­ğŸ', desc:'äººæ°—ãŒä¸ŠãŒã‚Šã€XPåŠ¹ç‡å°‘ã—UP', apply: (s)=>{s.popularity += 12; s.xp += 5; s.stage='ãƒ›ãƒƒãƒˆãƒ‰ãƒƒã‚°';}},
      {id:'mini', name:'ãƒŸãƒ‹ãƒ•ãƒ©ãƒ³ã‚¯', icon:'ğŸ¥¨ğŸŒ­', desc:'é•·ã•ã¯å°ã•ããªã‚‹ãŒå‘³ã®æ¿ƒã•UP', apply: (s)=>{s.length = Math.max(6, s.length-2); s.popularity += 5; s.stage='ãƒŸãƒ‹ãƒ•ãƒ©ãƒ³ã‚¯';}}
    ];
  } else if(threshold === EVOL_THRESHOLDS[1]) { // 80
    return [
      {id:'frank', name:'ãƒ•ãƒ©ãƒ³ã‚¯ãƒ•ãƒ«ãƒˆ', icon:'ğŸ‡©ğŸ‡ªğŸŒ­', desc:'é•·ã•ã¨äººæ°—ãŒå¤§å¹…UP', apply: (s)=>{s.length += 6; s.popularity += 18; s.stage='ãƒ•ãƒ©ãƒ³ã‚¯ãƒ•ãƒ«ãƒˆ';}},
      {id:'spicy', name:'ã‚¹ãƒ‘ã‚¤ã‚·ãƒ¼', icon:'ğŸŒ¶ï¸ğŸŒ­', desc:'äººæ°—ã¯è³›å¦ã‚ã‚Šã€‚ã‚¸ãƒ¥ãƒ¼ã‚·ãƒ¼æ¸›å°‘ã ãŒXPå¢—', apply: (s)=>{s.popularity += 10; s.juiciness -= 6; s.xp += 10; s.stage='ã‚¹ãƒ‘ã‚¤ã‚·ãƒ¼';}},
      {id:'gourmet', name:'ã‚°ãƒ«ãƒ¡ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸', icon:'ğŸ·ğŸŒ­', desc:'å…¨ä½“ãƒãƒ©ãƒ³ã‚¹ã«å„ªã‚Œã‚‹', apply: (s)=>{s.juiciness += 6; s.popularity += 10; s.length += 2; s.stage='ã‚°ãƒ«ãƒ¡';}}
    ];
  } else { // higher threshold 200
    return [
      {id:'legend', name:'ä¼èª¬ã®ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸', icon:'ğŸ†ğŸŒ­', desc:'åœ§å€’çš„ãªäººæ°—ã¨ç‰¹åˆ¥èƒ½åŠ›', apply: (s)=>{s.popularity += 40; s.juiciness += 20; s.stage='ä¼èª¬';}},
      {id:'street', name:'ã‚¹ãƒˆãƒªãƒ¼ãƒˆã‚½ã‚¦ãƒ«', icon:'ğŸššğŸŒ­', desc:'å¤šãã®é¡§å®¢ã‚’å¼•ãå¯„ã›ã‚‹', apply: (s)=>{s.popularity += 30; s.length += 10; s.stage='ã‚¹ãƒˆãƒªãƒ¼ãƒˆ';}},
      {id:'artisan', name:'è·äººä»•è¾¼ã¿', icon:'ğŸª“ğŸŒ­', desc:'é•·ãå®‰å®šã—ãŸä¾¡å€¤ã‚’ç”Ÿã‚€', apply: (s)=>{s.juiciness += 10; s.xp += 30; s.stage='è·äºº';}}
    ];
  }
}

function applyEvolution(option, threshold){
  option.apply(state);
  // record that this threshold used
  if(!state._evolvedAt) state._evolvedAt = [];
  state._evolvedAt.push(threshold);
  log(`é€²åŒ–ï¼ -> ${option.name} ã‚’é¸ã‚“ã ã€‚`);
  closeModal();
  saveState();
  render();
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
function openModal(){ modalBack.style.display = 'flex'; }
function closeModal(){ modalBack.style.display = 'none'; }

// ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
function render(){
  // Visual based on type and doneness
  let face = 'ğŸŒ­';
  if(state.type === 'cute') face = 'ğŸŒ­';
  else face = 'ğŸŒ­';
  // Represent doneness visually: color via text or emoji changes
  if(state.doneness > 120){
    sausageVisual.innerHTML = 'ğŸ”¥ğŸŒ­ğŸ”¥';
    sausageVisual.classList.add('burnt');
  } else if(state.doneness > 95){
    sausageVisual.innerHTML = 'ğŸŒ­ğŸ”¥';
    sausageVisual.classList.remove('burnt');
  } else if(state.doneness > 60){
    sausageVisual.innerHTML = 'ğŸ¥“ğŸŒ­';
    sausageVisual.classList.remove('burnt');
  } else {
    sausageVisual.innerHTML = face;
    sausageVisual.classList.remove('burnt');
  }

  stageTag.textContent = state.stage || 'ãƒ™ãƒ“ãƒ¼';
  lengthVal.textContent = state.length.toFixed(1);
  xpVal.textContent = Math.floor(state.xp);

  // build status list
  statusList.innerHTML = '';
  addStatRow('ç„¼ãåŠ æ¸›', Math.round(state.doneness), 0, 120, state.doneness>100 ? 'burnt' : '');
  addStatRow('ã‚¸ãƒ¥ãƒ¼ã‚·ãƒ¼åº¦', Math.round(state.juiciness), 0, 100);
  addStatRow('äººæ°—åº¦', Math.round(state.popularity), 0, 100);
  addStatRow('é•·ã• (cm)', Number(state.length.toFixed(1)), 0, 300);
  addStatRow('çµŒé¨“å€¤', Math.floor(state.xp), 0, 1000);

  // auto-scroll log to bottom
  logEl.scrollTop = logEl.scrollHeight;
}

function addStatRow(label, value, min=0, max=100, extraClass=''){
  const row = document.createElement('div');
  row.className = 'stat';
  const left = document.createElement('div');
  left.innerHTML = `<div style="font-weight:700">${label}</div><div class="small">${value}</div>`;
  const bar = document.createElement('div');
  bar.className = 'bar';
  const inner = document.createElement('i');
  let pct = 0;
  if(max>min) pct = ((value - min) / (max - min)) * 100;
  inner.style.width = pct + '%';
  bar.appendChild(inner);
  row.appendChild(left);
  row.appendChild(bar);
  statusList.appendChild(row);
}

// ãƒ­ã‚°
function log(text, alert=false){
  const p = document.createElement('div');
  p.innerHTML = `<span style="font-size:0.9rem">${new Date().toLocaleTimeString()}</span> - ${text}`;
  if(alert) p.style.color = '#b71c1c';
  logEl.appendChild(p);
}

// ç«¯æœ«è¨˜æ†¶
function saveState(){
  const toSave = {...state};
  // remove functions etc.
  localStorage.setItem('sausage_state_v1', JSON.stringify(toSave));
}
function saveStateAndLog(){
  saveState();
  log('ã‚²ãƒ¼ãƒ ã‚’ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸã€‚');
}

function loadState(){
  try{
    const raw = localStorage.getItem('sausage_state_v1');
    if(!raw) return null;
    const s = JSON.parse(raw);
    // make sure numeric fields exist
    return s;
  }catch(e){
    return null;
  }
}

function resetGame(){
  if(confirm('æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®é€²è¡Œã¯å¤±ã‚ã‚Œã¾ã™ã€‚')){
    localStorage.removeItem('sausage_state_v1');
    state = {...DEFAULT};
    selectionArea.style.display = '';
    document.getElementById('game-area').style.display = 'none';
    clearInterval(tickInterval);
    tickInterval = null;
    logEl.innerHTML = '';
    render();
  }
}

// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

// åˆæœŸãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ state ãŒã‚ã‚Œã°ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢è¡¨ç¤ºï¼‰
(function initOnLoad(){
  if(state && state.stage && state.stage !== 'ãƒ™ãƒ“ãƒ¼' || state.xp > 0 || (state.type && state.type!=='') ){
    // If state contains progress, resume
    selectionArea.style.display = 'none';
    document.getElementById('game-area').style.display = '';
    startTick();
    log('å‰å›ã®ã‚»ãƒ¼ãƒ–ã‹ã‚‰å†é–‹ã—ã¾ã—ãŸã€‚');
  }
  render();
})();

</script>
</body>
</html>
